<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WebAR（MindAR 圖像追蹤）— 上傳 .mind 目標 + 疊方塊</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial; background:#0b0c10; color:#e8f0fe; }
    header, footer { position:fixed; left:0; right:0; z-index:20; padding:10px 12px; display:flex; gap:12px; align-items:center; backdrop-filter: blur(8px); }
    header { top:0; background:rgba(20,22,28,.55); }
    footer { bottom:0; background:rgba(20,22,28,.55); justify-content:space-between; font-size:12px; }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    input[type="file"], input[type="number"] { background:#11141a; color:#e8f0fe; border:1px solid #2d3748; border-radius:10px; padding:8px 10px; }
    button { border:0; border-radius:999px; padding:10px 16px; font-weight:600; background:#4f46e5; color:white; cursor:pointer; box-shadow:0 6px 18px rgba(79,70,229,.35); }
    button:disabled { opacity:.5; cursor:not-allowed; }
    #status { font-size:12px; opacity:.85; }
    #ar-container { position:fixed; inset:0; }
  </style>

  <!-- Three.js + MindAR（UMD） -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image-three.prod.js"></script>
</head>
<body>
  <header>
    <div class="row" style="flex:1 1 auto;">
      <strong>MindAR 圖像追蹤 Demo</strong>
    </div>
    <div class="row">
      <label>目標檔（.mind）：
        <input id="mindFile" type="file" accept=".mind" />
      </label>
      <label>實際寬度（公分）：
        <input id="widthCm" type="number" value="15" min="1" step="1" />
      </label>
      <button id="startBtn" disabled>開始 AR</button>
      <button id="endBtn" disabled>結束</button>
    </div>
  </header>

  <div id="ar-container"></div>

  <footer>
    <div id="status">提示：此版本不依賴 WebXR；Android 與 iOS Safari 皆可用。請先用工具把圖片編成 <code>.mind</code> 後上傳。</div>
    <div>若看不到相機：請確認 HTTPS 或 localhost、允許相機權限。</div>
  </footer>

  <script>
    const mindFile = document.getElementById('mindFile');
    const startBtn = document.getElementById('startBtn');
    const endBtn = document.getElementById('endBtn');
    const widthCm = document.getElementById('widthCm');
    const statusEl = document.getElementById('status');
    const container = document.getElementById('ar-container');

    let mindarThree = null;
    let started = false;
    let objectURL = null;

    mindFile.addEventListener('change', () => {
      if (objectURL) URL.revokeObjectURL(objectURL);
      const file = mindFile.files?.[0];
      if (!file) { startBtn.disabled = true; return; }
      objectURL = URL.createObjectURL(file);
      startBtn.disabled = false;
      setStatus(`已載入目標檔：${file.name}。按「開始 AR」。`);
    });

    startBtn.addEventListener('click', async () => {
      if (!objectURL) { setStatus('請先選擇 .mind 檔。'); return; }
      if (started) return;

      try {
        const widthM = Math.max(0.01, Math.min(5.0, (parseFloat(widthCm.value || '15')/100)));
        // MindAR 初始化
        mindarThree = new window.MINDAR.IMAGE.MindARThree({
          container,
          imageTargetSrc: objectURL,     // 你的 .mind 目標檔
          uiLoading: "no", uiScanning: "no", uiError: "no" // 我們自己顯示訊息
        });

        const {renderer, scene, camera} = mindarThree;

        // 燈光
        const hemi = new THREE.HemisphereLight(0xffffff, 0x222244, 1.1);
        scene.add(hemi);
        const dir = new THREE.DirectionalLight(0xffffff, 0.7);
        dir.position.set(1, 2, 1);
        scene.add(dir);

        // Anchor 0（對應 .mind 檔的第一個目標）
        const anchor = mindarThree.addAnchor(0);

        // 疊加邊框（依實際寬度繪製一個矩形平面邊）
        const frameW = widthM, frameH = widthM * 1.0; // 近似比例，MindAR 不用你填比例也可
        const frameGeom = new THREE.PlaneGeometry(frameW, frameH);
        const frameEdges = new THREE.EdgesGeometry(frameGeom);
        const frame = new THREE.LineSegments(frameEdges, new THREE.LineBasicMaterial({transparent:true, opacity:0.75}));
        frame.position.z = 0.001;
        anchor.group.add(frame);

        // 疊加方塊（邊長 = 寬度 30%）
        const cubeSize = widthM * 0.3;
        const cube = new THREE.Mesh(
          new THREE.BoxGeometry(cubeSize, cubeSize, cubeSize),
          new THREE.MeshStandardMaterial({metalness:0.1, roughness:0.45})
        );
        cube.position.z = cubeSize/2;
        anchor.group.add(cube);

        await mindarThree.start(); // 取得相機，開始追蹤
        started = true;
        startBtn.disabled = true;
        endBtn.disabled = false;
        setStatus('AR 已啟動：將鏡頭對準你的目標圖片（與生成 .mind 的原圖一致）。');

        renderer.setAnimationLoop(() => { renderer.render(scene, camera); });
      } catch (e) {
        console.error(e);
        setStatus('啟動失敗：' + (e?.message || e));
      }
    });

    endBtn.addEventListener('click', async () => {
      if (!mindarThree || !started) return;
      await mindarThree.stop();
      await mindarThree.renderer.dispose();
      container.innerHTML = ''; // 清除 video/canvas
      started = false;
      startBtn.disabled = !objectURL;
      endBtn.disabled = true;
      setStatus('AR 已結束。可更換目標檔後再開啟。');
    });

    function setStatus(msg){ statusEl.textContent = msg; }

    // HTTPS 檢查
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      setStatus('請以 HTTPS 或 localhost 開啟，才能使用相機。');
    }
  </script>
</body>
</html>
