<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WebAR 圖像追蹤（上傳圖片 + 授權相機 + 疊方塊）</title>
  <style>
    :root { color-scheme: light dark; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, "Apple Color Emoji";
      background: #0b0c10; color: #e8f0fe;
    }
    header, footer {
      position: fixed; left: 0; right: 0; z-index: 10; padding: 10px 12px;
      display: flex; gap: 12px; align-items: center; backdrop-filter: blur(8px);
    }
    header { top: 0; background: rgba(20,22,28,.55); }
    footer { bottom: 0; background: rgba(20,22,28,.55); justify-content: space-between; }
    .row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    label { font-size: 14px; opacity: .9; }
    input[type="file"], input[type="number"] {
      background: #11141a; color: #e8f0fe; border: 1px solid #2d3748; border-radius: 10px; padding: 8px 10px;
    }
    input[type="number"] { width: 7em; }
    button {
      appearance: none; border: 0; border-radius: 999px; padding: 10px 16px; font-weight: 600;
      background: #4f46e5; color: white; cursor: pointer; box-shadow: 0 6px 18px rgba(79,70,229,.35);
    }
    button:disabled { opacity: .5; cursor: not-allowed; }
    #status { font-size: 12px; opacity: .85; }
    #hint { font-size: 12px; opacity: .75; }
    canvas { display: block; width: 100vw; height: 100vh; }
    .chip { font-size: 12px; padding: 4px 8px; border-radius: 999px; background:#1f2937; }
  </style>

  <!-- three.js ESM via import map -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.161.0/build/three.module.js"
    }
  }
  </script>
</head>
<body>
  <header>
    <div class="row" style="flex:1 1 auto;">
      <strong>WebAR 圖像追蹤 Demo</strong>
      <span class="chip" id="supportChip">檢查相容性中…</span>
    </div>
    <div class="row">
      <label>辨識圖：
        <input id="imgInput" type="file" accept="image/*" />
      </label>
      <label>實際寬度（公分）：
        <input id="imgWidth" type="number" value="15" min="1" step="1" />
      </label>
      <button id="permBtn">授權相機</button>
      <button id="startBtn" disabled>開啟 AR 相機</button>
      <button id="endBtn" disabled>結束</button>
    </div>
  </header>

  <canvas id="xr-canvas"></canvas>

  <footer>
    <div id="status">提示：請上傳高對比、具紋理的圖片；在 Android Chrome + HTTPS 下效果最佳。</div>
    <div id="hint">若沒出現授權或 AR：確認 HTTPS 或 localhost、相機權限允許、Android Chrome 版本。</div>
  </footer>

  <script type="module">
    import * as THREE from 'three';

    // ===== DOM =====
    const canvas = document.getElementById('xr-canvas');
    const imgInput = document.getElementById('imgInput');
    const imgWidthInput = document.getElementById('imgWidth');
    const startBtn = document.getElementById('startBtn');
    const endBtn = document.getElementById('endBtn');
    const permBtn = document.getElementById('permBtn');
    const statusEl = document.getElementById('status');
    const supportChip = document.getElementById('supportChip');

    // ===== three.js =====
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true, preserveDrawingBuffer: false });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera();
    scene.add(camera);

    scene.add(new THREE.HemisphereLight(0xffffff, 0x222244, 1.1));
    const dir = new THREE.DirectionalLight(0xffffff, 0.7);
    dir.position.set(1, 2, 1);
    scene.add(dir);

    const imageObjects = new Map();

    let xrSession = null;
    let trackedBitmap = null;
    let trackedWidthM = 0.15;
    let trackedAspect = 1.0;

    // ===== 相容性檢查 =====
    (async () => {
      if (!('xr' in navigator)) {
        setChip('不支援 WebXR', '#7c2d12');
        setStatus('此裝置或瀏覽器尚不支援 WebXR。建議 Android Chrome 測試。');
        disableRun();
        return;
      }
      const ok = await navigator.xr.isSessionSupported('immersive-ar').catch(() => false);
      if (ok) {
        setChip('支援 WebXR AR', '#065f46');
        setStatus('載入完成：請上傳辨識圖，設定寬度；可先按「授權相機」，再按「開啟 AR 相機」。');
      } else {
        setChip('不支援 AR Session', '#7c2d12');
        setStatus('瀏覽器雖有 WebXR，未支援 immersive-ar。請用 Android Chrome 或更新系統。');
        disableRun();
      }
    })();

    // ===== 權限工具 =====
    async function checkCameraPermission() {
      if (!navigator.permissions?.query) return 'unknown';
      try {
        const s = await navigator.permissions.query({ name: 'camera' });
        return s.state; // 'granted' | 'denied' | 'prompt'
      } catch { return 'unknown'; }
    }

    async function requestCameraPermission() {
      if (!navigator.mediaDevices?.getUserMedia) throw new Error('NO_GUM');
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      stream.getTracks().forEach(t => t.stop()); // 立刻關閉釋放
    }

    // ===== 事件：圖片上傳 =====
    imgInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      try {
        trackedBitmap = await createImageBitmap(file);
        trackedAspect = trackedBitmap.height / trackedBitmap.width;
        startBtn.disabled = false;
        setStatus(`已載入辨識圖：${trackedBitmap.width}×${trackedBitmap.height} 像素。請設定實際寬度並開啟 AR。`);
      } catch (err) {
        console.error(err);
        trackedBitmap = null;
        startBtn.disabled = true;
        setStatus('讀取圖片失敗，請重試或更換圖片。');
      }
    });

    // ===== 事件：授權相機（可選，但建議） =====
    permBtn.addEventListener('click', async () => {
      try {
        const state = await checkCameraPermission();
        if (state === 'granted') {
          setStatus('相機權限已取得，可直接開啟 AR。');
          return;
        }
        if (state === 'denied') {
          setStatus('相機權限先前被拒。請到瀏覽器/系統設定→網站權限→相機→允許，然後重整。');
          return;
        }
        await requestCameraPermission();
        setStatus('相機權限已取得。');
      } catch (e) {
        console.warn(e);
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
          setStatus('授權失敗：需在 HTTPS 或 localhost 下才能請求相機權限。');
        } else {
          setStatus('授權失敗：請檢查瀏覽器相機權限設定。');
        }
      }
    });

    // ===== 事件：開始 AR =====
    startBtn.addEventListener('click', async () => {
      if (!trackedBitmap) { setStatus('請先上傳辨識圖。'); return; }
      trackedWidthM = clamp(parseFloat(imgWidthInput.value || '15') / 100, 0.01, 5.0);

      // 先預檢相機權限（確保有使用者手勢）
      try {
        const state = await checkCameraPermission();
        if (state === 'denied') {
          setStatus('啟動失敗：相機權限被拒。請到瀏覽器/系統設定開啟後再試。');
          return;
        }
        if (state !== 'granted') {
          await requestCameraPermission(); // 會跳原生授權一次
        }
      } catch {
        // 某些瀏覽器缺 Permissions API，略過；WebXR 仍會再請權
      }

      try {
        const init = {
          requiredFeatures: ['local'],
          optionalFeatures: [
            'dom-overlay',
            // 有些實作仍需要宣告 image-tracking；放 optional 不會影響不支援者
            'image-tracking'
          ],
          domOverlay: { root: document.body },
          trackedImages: [{ image: trackedBitmap, widthInMeters: trackedWidthM }]
        };

        xrSession = await navigator.xr.requestSession('immersive-ar', init);
        await renderer.xr.setSession(xrSession);

        if (!imageObjects.has(0)) {
          const content = buildContentGroup(trackedWidthM, trackedAspect);
          imageObjects.set(0, content);
          scene.add(content);
        }

        xrSession.addEventListener('end', onSessionEnded);
        window.addEventListener('resize', onResize);

        startBtn.disabled = true;
        endBtn.disabled = false;
        setStatus('AR 已啟動：將鏡頭對準你的辨識圖。');

        renderer.setAnimationLoop((t, frame) => {
          if (frame?.getImageTrackingResults) {
            const results = frame.getImageTrackingResults();
            for (const result of results) {
              const index = result.index; // 0
              const group = imageObjects.get(index);
              if (!group) continue;

              const pose = frame.getPose(result.imageSpace, renderer.xr.getReferenceSpace());
              if (pose) {
                group.visible = result.trackingState !== 'untracked';
                group.matrix.fromArray(pose.transform.matrix);
              } else {
                group.visible = false;
              }
            }
          }
          renderer.render(scene, camera);
        });

      } catch (err) {
        console.error(err);
        if (err?.name === 'NotAllowedError' || err?.name === 'SecurityError') {
          setStatus('啟動失敗：未授權相機或非 HTTPS/localhost。請確認權限與連線方式。');
        } else if (err?.name === 'NotSupportedError') {
          setStatus('啟動失敗：此裝置/瀏覽器尚未支援 WebXR AR 或 Image Tracking。');
        } else {
          setStatus('啟動 AR 失敗：' + (err?.message || err));
        }
        xrSession = null;
        startBtn.disabled = !trackedBitmap;
        endBtn.disabled = true;
      }
    });

    // ===== 事件：結束 AR =====
    endBtn.addEventListener('click', async () => {
      if (xrSession) await xrSession.end();
    });

    function onSessionEnded() {
      renderer.setAnimationLoop(null);
      try { xrSession.removeEventListener('end', onSessionEnded); } catch {}
      xrSession = null;
      startBtn.disabled = !trackedBitmap;
      endBtn.disabled = true;
      setStatus('AR 已結束。你可以更換辨識圖後再次啟動。');
    }

    // ===== 3D 內容：圖片邊框 + 方塊 =====
    function buildContentGroup(widthM, aspect) {
      const group = new THREE.Group();
      group.matrixAutoUpdate = false;
      group.visible = false;

      const heightM = widthM * aspect;
      const plane = new THREE.PlaneGeometry(widthM, heightM);
      const edges = new THREE.EdgesGeometry(plane);
      const frame = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ transparent: true, opacity: 0.75 }));
      frame.position.z = 0.001;
      group.add(frame);

      const cubeSize = widthM * 0.3;
      const cube = new THREE.Mesh(
        new THREE.BoxGeometry(cubeSize, cubeSize, cubeSize),
        new THREE.MeshStandardMaterial({ metalness: 0.1, roughness: 0.45 })
      );
      cube.position.z = cubeSize / 2;
      group.add(cube);

      const axes = new THREE.AxesHelper(widthM * 0.6);
      axes.position.z = 0.002;
      axes.visible = false;
      group.add(axes);

      return group;
    }

    // ===== 工具 =====
    function onResize() { renderer.setSize(window.innerWidth, window.innerHeight); }
    function setStatus(msg) { statusEl.textContent = msg; }
    function setChip(text, bg) { supportChip.textContent = text; supportChip.style.background = bg; }
    function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }
    function disableRun() { startBtn.disabled = true; permBtn.disabled = true; }

    // ===== HTTPS 提醒 =====
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      setStatus('建議用 HTTPS 或在本機 localhost 啟動伺服器，才能請求相機權限與啟動 AR。');
    }
  </script>
</body>
</html>
